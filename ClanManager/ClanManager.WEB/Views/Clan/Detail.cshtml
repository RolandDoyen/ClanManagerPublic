@using ClanManager.WEB.Models.Clan
@model ClanViewModel
@using ClanManager.Core
@using ClanManager.Core.Resources

@{
    ViewData["Title"] = "Clan Detail";
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

<div class="container mt-5 d-flex justify-content-center">
    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

    <div class="card shadow-lg rounded-3 clan-detail-card">
        <div class="card-header detail-text">
            <h2 class="mb-0 fw-bold text-center text-white">@Model.Name [@Model.Tag]</h2>
        </div>
        
        @if (Model.IsSessionUserAdmin)
        {
            <form asp-action="ToggleActive" asp-controller="Clan" method="post">
                <input type="hidden" asp-for="Id" />

                <div class="card-footer d-flex justify-content-center align-items-center">
                    <button type="submit" class="btn btn-danger">
                        @if (!Model.IsActive)
                        {
                            @Resources.Button_Activate
                        }
                        else
                        {
                            @Resources.Button_Deactivate
                        }
                    </button>
                </div>
            </form>            
        }

        @if (Model.CanSessionUserJoinQuit)
        {
            @if (Model.IsActive)
            {
                if (Model.IsSessionUserMember && !Model.IsSessionUserLeader)
                {
                    <form asp-action="RemoveMember" asp-controller="Clan" method="post">
                        <input type="hidden" asp-for="Id" />

                        <div class="card-footer d-flex justify-content-center align-items-center">
                            <button type="submit" class="btn btn-danger">
                                @Resources.Quit
                            </button>
                        </div>
                    </form>
                }
                else if(!Model.IsSessionUserMember)
                {
                    <form asp-action="Join" asp-controller="Clan" method="post">
                        <input type="hidden" asp-for="Id" />

                        <div class="card-footer d-flex justify-content-center align-items-center">
                            <button type="submit" class="btn btn-danger">
                                @Resources.Join
                            </button>
                        </div>
                    </form>
                }
                else if(Model.IsSessionUserLeader)
                {
                    <form asp-action="Delete" asp-controller="Clan" method="post">
                        <input type="hidden" asp-for="Id" />

                        <div class="card-footer d-flex justify-content-center align-items-center">
                            <button type="submit" class="btn btn-danger">
                                @Resources.Button_DeleteClan
                            </button>
                        </div>
                    </form>
                }
            }
            else
            {
                <span>CLAN IS NOT ACTIVE</span>
            }
        }               
        
        <div class="card-body">
            <p class="mb-2">
                @if(!string.IsNullOrEmpty(Model.LeaderEmail))
                {
                    <strong>@Resources.Leader :</strong> <span class="text-secondary">@Model.LeaderEmail</span>
                }
                else
                {
                    <strong>@Resources.Leader :</strong> <span class="text-secondary">@Resources.No_Leader_Found</span>
                }
            </p>
        </div>
        <div class="card-body">
            <p class="mb-2">
                @if (!Model.IsEditingDescription)
                {
                    <strong>@Resources.Description :</strong>
                    <br/>
                    <span class="text-secondary clan-description">@Model.Description</span>

                    @if (Model.IsSessionUserLeader)
                    {
                        <form method="get" asp-action="Detail" class="d-inline">
                            <input type="hidden" asp-for="Id" />
                            <input type="hidden" name="editDescription" value="true" />

                            <button type="submit" class="btn btn-sm btn-primary ms-2">
                                @Resources.Button_Edit
                            </button>
                        </form>
                    }
                }
                @if (Model.IsEditingDescription && Model.IsSessionUserLeader)
                {
                    <form method="post" asp-action="UpdateDescription" class="mt-2">                        
                        <input type="hidden" asp-for="Id" />

                        <textarea asp-for="Description" class="form-control" rows="3" data-></textarea>

                        <button type="submit" class="btn btn-success btn-sm mt-2">
                            @Resources.Button_Save
                        </button>

                        <button formaction="/Clan/CancelDescriptionEdit" class="btn btn-secondary btn-sm mt-2">
                            @Resources.Button_Cancel
                        </button>
                    </form>
                }
            </p>
        </div>
    </div>
</div>

<table class="table table-striped table-bordered align-middle w-auto mx-auto clan-members">
    <tbody>
        @foreach (var member in Model.Members)
        {
            <tr>
                <td class="px-3">
                    <span class="text-primary fw-bold clan-member-email">
                        @member.User.Email
                    </span>
                </td>

                <td class="text-center text-primary fw-bold clan-member-role">
                    @member.ClanRole
                </td>
                @if (member.CanChangeMemberRole || member.CanRemoveMember)
                {
                    <td class="text-end px-3 change-role">
                        @if (member.CanChangeMemberRole)
                        {
                            <form asp-action="ChangeMemberRole" asp-controller="Clan" method="post" class="d-inline-flex align-items-center me-2">
                                <input type="hidden" asp-for="Id" />
                                <input type="hidden" name="targetUserId" value="@member.User.Id" />

                                <select name="newRole" class="form-select form-select-sm w-auto me-2">
                                    @foreach (var role in Enum.GetValues(typeof(ClanRole)).Cast<ClanRole>())
                                    {
                                        if (Model.IsSessionUserCoLeader && (role == ClanRole.ClanLeader || role == ClanRole.CoLeader))
                                            continue;

                                        <option value="@role" selected="@(role == member.ClanRole)">@role</option>
                                    }
                                </select>

                                <button type="submit" class="btn btn-warning btn-sm">
                                    @Resources.Button_Change_Role
                                </button>
                            </form>                            
                        }

                        @if (member.CanRemoveMember)
                        {
                            <form asp-action="RemoveMember" asp-controller="Clan" method="post" class="d-inline">
                                <input type="hidden" asp-for="Id" />
                                <input type="hidden" name="targetUserId" value="@member.User.Id" />

                                <button type="submit" class="btn btn-danger btn-sm">@Resources.Button_Remove</button>
                            </form>                            
                        }
                    </td>
                }
            </tr>
        }
    </tbody>
</table>